<h1 id="nginx-letsencrypt-docker-multistack-web-app">nginx + letsencrypt + docker = multistack web app</h1>
<p><strong>Difficulty Level</strong>: entry</p>
<p>Imagine that we have a few different web services which work on different languages, environment with its own configuration set.</p>
<p>What would be the approach of running applications on staging or live environment easily without overengineering and easy deployment process with CI pipelines.</p>
<p>Obvious first response is to use <strong>docker</strong> for wrapping our applications into different environmemts.</p>
<p>But how would we route traffic from incoming requests into various docker containers?</p>
<p>The answer is to use <strong>nginx</strong> as a reverse proxy and route traffic based on domain name or path name.</p>
<p>And for taste of being encrypted and have all those services and microservices behind https we use free <strong>Let’s encrypt</strong> certificates and their bot to keep certificates and configuration up-to-date automatically.</p>
<p>-more-</p>
<h2 id="input-data">Input data</h2>
<p>We have:</p>
<ul>
<li>a FQDN: <code>example.com</code></li>
<li>a VPS or bare metal <code>server</code> (let’s say debian/ubuntu)</li>
<li>an api backend web application wrapped into a container image (let’s call it <code>api-container</code> and let’s assume it needs to respond to <code>api.example.com</code>)</li>
<li>a SPA web application wrapped into another container image (let’s call it <code>spa-container</code> and let’s assume it needs to respond to <code>example.com</code> directly)</li>
</ul>
<h2 id="action">Action</h2>
<h3 id="installation-steps">Installation steps</h3>
<ol type="1">
<li><strong>ssh</strong> into our server</li>
<li>Install <strong>nginx</strong>:</li>
</ol>
<pre><code>$ apt-get install nginx</code></pre>
<ol start="3" type="1">
<li>Install <strong>docker</strong>:<br />
(<a href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a>)</li>
<li>Install <strong>certbot</strong>:</li>
</ol>
<pre><code>$ apt-get install certbot</code></pre>
<ol start="5" type="1">
<li>Install certbot <strong>plugin</strong> for nginx (<code>python3-certbot-nginx</code>):</li>
</ol>
<pre><code>$ apt-get install python3-certbot-nginx</code></pre>
<h3 id="configuration-steps">Configuration steps</h3>
<ol type="1">
<li>Configure <strong>nginx</strong> to work as a reverse proxy for <code>spa-container</code> and <code>api-container</code>, so open conf file (use editor of your choise nano/vi/vim/etc):</li>
</ol>
<pre><code>$ nano /etc/nginx/conf.d/default.conf</code></pre>
<p>Add entries for two new server sections:</p>
<pre><code>...
server {
   listen 80;
   server_name example.com;
   location / {
       proxy_pass  http://127.0.0.1:8001/;
   }
}

server {
   listen 80;
   server_name api.example.com;
   location / {
       proxy_pass  http://127.0.0.1:8002/;
   }
}
...</code></pre>
